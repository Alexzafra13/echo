
> echo-server-backend@1.0.0 test
> jest

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 4 ‚Üí music_server_test_4

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 3 ‚Üí music_server_test_3

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

FAIL src/features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts
  DeleteUserUseCase
    execute
      ‚úì deber√≠a desactivar un usuario normal correctamente (25 ms)
      ‚úï deber√≠a permitir desactivar un admin si hay m√°s admins
      ‚úï deber√≠a lanzar error si intenta desactivar el √∫ltimo admin (5 ms)
      ‚úì deber√≠a lanzar error si el usuario no existe (1 ms)
      ‚úì deber√≠a hacer soft delete (no eliminar f√≠sicamente) (1 ms)
      ‚úï no deber√≠a verificar admins si el usuario a desactivar no es admin (1 ms)
      ‚úï deber√≠a contar solo admins activos al verificar el √∫ltimo admin (2 ms)

  ‚óè DeleteUserUseCase ‚Ä∫ execute ‚Ä∫ deber√≠a permitir desactivar un admin si hay m√°s admins

    Cannot delete system administrator

      34 |     // 3. No permitir eliminar al system admin
      35 |     if (isSystemAdmin) {
    > 36 |       throw new ValidationError('Cannot delete system administrator');
         |             ^
      37 |     }
      38 |
      39 |     // 4. Prevenir eliminaci√≥n del usuario actual si es el √∫nico admin

      at DeleteUserUseCase.execute (features/admin/domain/use-cases/delete-user/delete-user.use-case.ts:36:13)
      at Object.<anonymous> (features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts:118:22)

  ‚óè DeleteUserUseCase ‚Ä∫ execute ‚Ä∫ deber√≠a lanzar error si intenta desactivar el √∫ltimo admin

    expect(received).rejects.toThrow(expected)

    Expected substring: "Cannot delete the last admin user"
    Received message:   "Cannot delete system administrator"

          34 |     // 3. No permitir eliminar al system admin
          35 |     if (isSystemAdmin) {
        > 36 |       throw new ValidationError('Cannot delete system administrator');
             |             ^
          37 |     }
          38 |
          39 |     // 4. Prevenir eliminaci√≥n del usuario actual si es el √∫nico admin

      at DeleteUserUseCase.execute (features/admin/domain/use-cases/delete-user/delete-user.use-case.ts:36:13)
      at Object.<anonymous> (features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts:184:7)
      at Object.toThrow (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts:184:52)

  ‚óè DeleteUserUseCase ‚Ä∫ execute ‚Ä∫ no deber√≠a verificar admins si el usuario a desactivar no es admin

    expect(jest.fn()).not.toHaveBeenCalled()

    Expected number of calls: 0
    Received number of calls: 1

    1: 0, 1000

      271 |
      272 |       // Assert
    > 273 |       expect(mockUserRepository.findAll).not.toHaveBeenCalled();
          |                                              ^
      274 |     });
      275 |
      276 |     it('deber√≠a contar solo admins activos al verificar el √∫ltimo admin', async () => {

      at Object.<anonymous> (features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts:273:46)

  ‚óè DeleteUserUseCase ‚Ä∫ execute ‚Ä∫ deber√≠a contar solo admins activos al verificar el √∫ltimo admin

    expect(received).rejects.toThrow(expected)

    Expected substring: "Cannot delete the last admin user"
    Received message:   "Cannot delete system administrator"

          34 |     // 3. No permitir eliminar al system admin
          35 |     if (isSystemAdmin) {
        > 36 |       throw new ValidationError('Cannot delete system administrator');
             |             ^
          37 |     }
          38 |
          39 |     // 4. Prevenir eliminaci√≥n del usuario actual si es el √∫nico admin

      at DeleteUserUseCase.execute (features/admin/domain/use-cases/delete-user/delete-user.use-case.ts:36:13)
      at Object.<anonymous> (features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts:319:7)
      at Object.toThrow (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts:319:52)

PASS src/features/playlists/domain/use-cases/add-track-to-playlist/add-track-to-playlist.use-case.spec.ts
  AddTrackToPlaylistUseCase
    execute
      ‚úì should add track to playlist successfully (25 ms)
      ‚úì should use addTrackWithAutoOrder for race-condition safe ordering (1 ms)
      ‚úì should throw error if playlistId is empty (15 ms)
      ‚úì should throw error if trackId is empty (1 ms)
      ‚úì should throw error if playlist not found (1 ms)
      ‚úì should throw error if track not found (2 ms)
      ‚úì should throw error if track already in playlist (1 ms)
      ‚úì should update playlist metadata (duration, size, songCount) (1 ms)

  console.log
    üß™ Test Worker 3 ‚Üí music_server_test_3

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 4 ‚Üí music_server_test_4

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/albums/infrastructure/persistence/cached-album.repository.spec.ts
  CachedAlbumRepository
    findById
      ‚úì should return cached album on cache hit (26 ms)
      ‚úì should fetch from DB and cache on cache miss (1 ms)
      ‚úì should return null if album not found (2 ms)
    findAll
      ‚úì should NOT cache paginated list (1 ms)
    search
      ‚úì should NOT cache search results (1 ms)
    findByArtistId
      ‚úì should return cached albums on cache hit (1 ms)
      ‚úì should fetch from DB and cache on cache miss (1 ms)
      ‚úì should NOT cache empty results (1 ms)
    findRecent
      ‚úì should cache recent albums with shorter TTL (1 ms)
      ‚úì should return cached recent albums on cache hit (1 ms)
    findMostPlayed
      ‚úì should cache most played albums (1 ms)
    count
      ‚úì should cache count with long TTL (1 ms)
      ‚úì should return cached count on cache hit
    create
      ‚úì should create album and invalidate list caches (1 ms)
    update
      ‚úì should update album and invalidate caches (4 ms)
      ‚úì should NOT invalidate cache if update fails (1 ms)
    delete
      ‚úì should delete album and invalidate caches
      ‚úì should NOT invalidate cache if delete fails (1 ms)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/artists/domain/use-cases/get-artists/get-artists.use-case.spec.ts
  GetArtistsUseCase
    execute
      ‚úì deber√≠a retornar lista paginada con valores por defecto (36 ms)
      ‚úì deber√≠a aplicar paginaci√≥n correctamente (4 ms)
      ‚úì deber√≠a limitar take a m√°ximo 100 (2 ms)
      ‚úì deber√≠a establecer hasMore en false cuando no hay m√°s resultados (2 ms)
      ‚úì deber√≠a convertir skip negativo a 0 (3 ms)
      ‚úì deber√≠a convertir take menor a 1 a 1 (2 ms)
      ‚úì deber√≠a manejar resultado vac√≠o (2 ms)
      ‚úì deber√≠a mapear correctamente todos los campos de los artistas (2 ms)
      ‚úì deber√≠a usar valores por defecto si no se provee skip/take (2 ms)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

[31m[Nest] 20345  - [39m11/17/2025, 3:31:37 PM [31m  ERROR[39m [38;5;3m[CleanupService] [39m[31mFailed to cleanup artist files: Permission denied[39m
Error: Permission denied
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/cleanup.service.spec.ts:156:48)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20345  - [39m11/17/2025, 3:31:37 PM [31m  ERROR[39m [38;5;3m[CleanupService] [39m[31mFailed to cleanup album files: Permission denied[39m
Error: Permission denied
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/cleanup.service.spec.ts:156:48)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
FAIL src/features/external-metadata/infrastructure/services/cleanup.service.spec.ts
  CleanupService
    cleanupOrphanedFiles
      ‚úì deber√≠a ejecutar en modo dry-run sin eliminar archivos (11 ms)
      ‚úì deber√≠a detectar archivos hu√©rfanos sin eliminarlos (dry-run) (3 ms)
      ‚úì deber√≠a eliminar archivos hu√©rfanos en modo real (2 ms)
      ‚úì deber√≠a manejar errores durante la limpieza (16 ms)
    getStorageStats
      ‚úì deber√≠a calcular estad√≠sticas de almacenamiento (2 ms)
      ‚úì deber√≠a manejar caso sin metadatos (2 ms)
    recalculateStorageSizes
      ‚úì deber√≠a recalcular tama√±os para todos los artistas (2 ms)
      ‚úì deber√≠a manejar errores individuales sin fallar todo (2 ms)
      ‚úì deber√≠a retornar 0 updates si no hay artistas (3 ms)
    verifyIntegrity
      ‚úï deber√≠a verificar integridad de archivos referenciados (3 ms)
      ‚úï deber√≠a detectar archivos faltantes (2 ms)
      ‚úì deber√≠a manejar caso sin archivos para verificar (1 ms)

  ‚óè CleanupService ‚Ä∫ verifyIntegrity ‚Ä∫ deber√≠a verificar integridad de archivos referenciados

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 5

      306 |
      307 |       // Assert
    > 308 |       expect(result.totalChecked).toBe(3); // 2 artist images + 1 album cover
          |                                   ^
      309 |       expect(result.missing).toEqual([]);
      310 |       expect(result.errors).toEqual([]);
      311 |     });

      at Object.<anonymous> (features/external-metadata/infrastructure/services/cleanup.service.spec.ts:308:35)

  ‚óè CleanupService ‚Ä∫ verifyIntegrity ‚Ä∫ deber√≠a detectar archivos faltantes

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 4

      335 |
      336 |       // Assert
    > 337 |       expect(result.totalChecked).toBe(1);
          |                                   ^
      338 |       expect(result.missing.length).toBe(1);
      339 |       expect(result.missing[0]).toContain('Artist 1');
      340 |     });

      at Object.<anonymous> (features/external-metadata/infrastructure/services/cleanup.service.spec.ts:337:35)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 3 ‚Üí music_server_test_3

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

FAIL src/features/users/presentation/users.controller.spec.ts
  UsersController
    PUT /users/password - changePassword
      ‚úì deber√≠a cambiar la contrase√±a correctamente (11 ms)
      ‚úì deber√≠a usar el userId del usuario autenticado (3 ms)
      ‚úì deber√≠a propagar errores del use case (18 ms)
    PUT /users/profile - updateProfile
      ‚úï deber√≠a actualizar el perfil correctamente (5 ms)
      ‚úì deber√≠a actualizar solo el nombre (2 ms)
      ‚úì deber√≠a actualizar solo el email (2 ms)
    PUT /users/theme - changeTheme
      ‚úì deber√≠a cambiar el tema a dark (1 ms)
      ‚úì deber√≠a cambiar el tema a light (2 ms)
      ‚úì deber√≠a propagar errores de validaci√≥n (4 ms)
    PUT /users/language - changeLanguage
      ‚úì deber√≠a cambiar el idioma a espa√±ol (2 ms)
      ‚úì deber√≠a cambiar el idioma a ingl√©s (2 ms)
      ‚úì deber√≠a propagar errores de validaci√≥n (2 ms)

  ‚óè UsersController ‚Ä∫ PUT /users/profile - updateProfile ‚Ä∫ deber√≠a actualizar el perfil correctamente

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 2

    - Object {
    + UserResponseDto {
    +   "avatarUrl": "/api/images/users/user-123/avatar",
        "email": "updated@test.com",
        "id": "user-123",
        "name": "Updated Name",
        "username": "testuser",
      }

      178 |         email: 'updated@test.com',
      179 |       });
    > 180 |       expect(result).toEqual(useCaseResponse);
          |                      ^
      181 |     });
      182 |
      183 |     it('deber√≠a actualizar solo el nombre', async () => {

      at Object.<anonymous> (features/users/presentation/users.controller.spec.ts:180:22)

PASS src/features/recommendations/infrastructure/jobs/wave-mix-scheduler.service.spec.ts
  WaveMixSchedulerService
    ‚úì should be defined (4 ms)
    onModuleInit
      ‚úì deber√≠a registrar el procesador y programar la regeneraci√≥n diaria (9 ms)
    regenerateAllWaveMixes
      ‚úì deber√≠a regenerar Wave Mix para todos los usuarios (2 ms)
      ‚úì deber√≠a manejar errores individuales sin fallar todo el proceso (2 ms)
    regenerateUserWaveMix
      ‚úì deber√≠a regenerar Wave Mix para un usuario espec√≠fico (1 ms)
    triggerUserRegeneration
      ‚úì deber√≠a encolar un job de regeneraci√≥n para un usuario (2 ms)
    triggerImmediateRegeneration
      ‚úì deber√≠a encolar un job de regeneraci√≥n inmediata para todos los usuarios (1 ms)

  console.log
    üß™ Test Worker 3 ‚Üí music_server_test_3

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 4 ‚Üí music_server_test_4

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/auth/presentation/auth.controller.spec.ts
  AuthController
    POST /auth/login
      ‚úì deber√≠a retornar tokens v√°lidos en login exitoso (2 ms)
      ‚úì deber√≠a retornar mustChangePassword true para usuarios nuevos
      ‚úì deber√≠a lanzar error 401 con credenciales inv√°lidas (13 ms)
      ‚úì deber√≠a lanzar error si username est√° vac√≠o (1 ms)
      ‚úì deber√≠a lanzar error si password est√° vac√≠o (1 ms)
    POST /auth/refresh
      ‚úì deber√≠a generar nuevos tokens (1 ms)
      ‚úì deber√≠a lanzar error con token inv√°lido
      ‚úì deber√≠a lanzar error con token expirado (1 ms)
    GET /auth/me
      ‚úì deber√≠a retornar el usuario autenticado (1 ms)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

[33m[Nest] 20351  - [39m11/17/2025, 3:31:40 PM [33m   WARN[39m [38;5;3m[WsThrottlerGuard] [39m[33m‚ö†Ô∏è Rate limit exceeded for client test-socket-id[39m
[33m[Nest] 20351  - [39m11/17/2025, 3:31:40 PM [33m   WARN[39m [38;5;3m[WsThrottlerGuard] [39m[33m‚ö†Ô∏è Rate limit exceeded for client test-socket-id[39m
PASS src/features/scanner/infrastructure/gateways/scanner.gateway.spec.ts
  ScannerGateway
    lifecycle
      ‚úì should be defined (5 ms)
      ‚úì should log on init (2 ms)
      ‚úì should log on connection (3 ms)
      ‚úì should log on disconnection (6 ms)
    handleSubscribe
      ‚úì should join client to scan room (2 ms)
    handleUnsubscribe
      ‚úì should remove client from scan room (1 ms)
    emitProgress
      ‚úì should emit progress to scan room (1 ms)
    emitError
      ‚úì should emit error to scan room (3 ms)
    emitCompleted
      ‚úì should emit completed to scan room (1 ms)
    handlePause
      ‚úì should emit paused confirmation (1 ms)
    handleCancel
      ‚úì should emit cancelled confirmation (2 ms)
    handleResume
      ‚úì should emit resumed confirmation (1 ms)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

[31m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[ImageDownloadService] [39m[31mError downloading image from https://example.com/notfound.jpg: HTTP 404: Not Found[39m
Error: HTTP 404: Not Found
    at ImageDownloadService.downloadImage (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.ts:50:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.spec.ts:106:7)
[31m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[ImageDownloadService] [39m[31mError downloading image from https://example.com/file.html: Invalid content type: text/html[39m
Error: Invalid content type: text/html
    at ImageDownloadService.downloadImage (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.ts:56:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.spec.ts:124:7)
[31m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[ImageDownloadService] [39m[31mError downloading image from https://example.com/large.jpg: Image too large: 11534336 bytes[39m
Error: Image too large: 11534336 bytes
    at ImageDownloadService.downloadImage (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.ts:62:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.spec.ts:144:7)
[31m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[ImageDownloadService] [39m[31mError downloading image from https://example.com/large.jpg: Image too large: 11534336 bytes[39m
Error: Image too large: 11534336 bytes
    at ImageDownloadService.downloadImage (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.ts:71:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.spec.ts:164:7)
[31m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[ImageDownloadService] [39m[31mError downloading image from https://example.com/invalid.jpg: Downloaded file is not a valid image[39m
Error: Downloaded file is not a valid image
    at ImageDownloadService.downloadImage (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.ts:76:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.spec.ts:184:7)
[31m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[ImageDownloadService] [39m[31mError downloading image from https://example.com/image.jpg: Network error[39m
Error: Network error
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.spec.ts:191:53)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[ImageDownloadService] [39m[31mError downloading image from https://example.com/image.jpg: Download failed[39m
Error: Download failed
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.spec.ts:224:53)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[ImageDownloadService] [39m[31mError downloading and saving image from https://example.com/image.jpg to /path/to/save.jpg: Download failed[39m
Error: Download failed
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.spec.ts:224:53)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[ImageDownloadService] [39m[31mError downloading and saving image from https://example.com/image.jpg to /path/to/save.jpg: Save failed[39m
Error: Save failed
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.spec.ts:245:43)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[ImageDownloadService] [39m[31mError downloading image from https://example.com/image2.jpg: Network error[39m
Error: Network error
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.spec.ts:309:32)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[ImageDownloadService] [39m[31mError downloading image from https://example.com/medium.jpg: Network error[39m
Error: Network error
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.spec.ts:402:32)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[ImageDownloadService] [39m[31mError downloading and saving image from https://example.com/medium.jpg to /storage/artists/123/profile-medium.jpg: Network error[39m
Error: Network error
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/infrastructure/services/image-download.service.spec.ts:402:32)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
PASS src/features/external-metadata/infrastructure/services/image-download.service.spec.ts
  ImageDownloadService
    downloadImage
      ‚úì deber√≠a descargar una imagen v√°lida (4 ms)
      ‚úì deber√≠a rechazar si HTTP status no es OK (19 ms)
      ‚úì deber√≠a rechazar si content-type no es imagen (2 ms)
      ‚úì deber√≠a rechazar si imagen es muy grande (content-length) (1 ms)
      ‚úì deber√≠a rechazar si buffer descargado es muy grande (3 ms)
      ‚úì deber√≠a rechazar si buffer no contiene imagen v√°lida (3 ms)
      ‚úì deber√≠a manejar errores de red (5 ms)
    downloadAndSave
      ‚úì deber√≠a descargar y guardar una imagen (2 ms)
      ‚úì deber√≠a propagar errores de descarga (3 ms)
      ‚úì deber√≠a propagar errores de guardado (2 ms)
    downloadMultiple
      ‚úì deber√≠a descargar m√∫ltiples im√°genes en paralelo (1 ms)
      ‚úì deber√≠a manejar errores individuales sin fallar todo (2 ms)
    downloadMultipleSizes
      ‚úì deber√≠a descargar m√∫ltiples tama√±os de imagen (2 ms)
      ‚úì deber√≠a manejar URLs faltantes (1 ms)
      ‚úì deber√≠a continuar si alg√∫n tama√±o falla (2 ms)
    getImageFormat
      ‚úì deber√≠a detectar formato JPEG (1 ms)
      ‚úì deber√≠a detectar formato PNG (1 ms)
      ‚úì deber√≠a detectar formato GIF (1 ms)
      ‚úì deber√≠a detectar formato WebP (1 ms)
      ‚úì deber√≠a retornar null para buffer inv√°lido (1 ms)
      ‚úì deber√≠a retornar null para buffer muy peque√±o (1 ms)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/admin/presentation/admin.controller.spec.ts
  AdminController
    POST /admin/users - createUser
      ‚úì deber√≠a crear un usuario correctamente (11 ms)
      ‚úì deber√≠a crear un usuario admin (3 ms)
      ‚úì deber√≠a crear usuario sin email (3 ms)
      ‚úì deber√≠a propagar error del use case (13 ms)
    GET /admin/users - listUsers
      ‚úì deber√≠a listar usuarios sin par√°metros (6 ms)
      ‚úì deber√≠a listar usuarios con paginaci√≥n (2 ms)
      ‚úì deber√≠a convertir skip y take a n√∫meros (1 ms)
      ‚úì deber√≠a manejar skip sin take (2 ms)
      ‚úì deber√≠a manejar take sin skip (3 ms)
      ‚úì deber√≠a retornar lista vac√≠a si no hay usuarios (1 ms)
    PUT /admin/users/:id - updateUser
      ‚úì deber√≠a actualizar un usuario correctamente (1 ms)
      ‚úì deber√≠a actualizar el rol de admin de un usuario (2 ms)
      ‚úì deber√≠a actualizar el estado activo de un usuario (1 ms)
      ‚úì deber√≠a propagar error del use case (2 ms)
    DELETE /admin/users/:id - deleteUser
      ‚úì deber√≠a desactivar un usuario correctamente (1 ms)
      ‚úì deber√≠a propagar error si intenta eliminar el √∫ltimo admin (2 ms)
      ‚úì deber√≠a propagar error si el usuario no existe (2 ms)
    POST /admin/users/:id/reset-password - resetUserPassword
      ‚úì deber√≠a resetear la contrase√±a de un usuario correctamente (2 ms)
      ‚úì deber√≠a generar una contrase√±a temporal alfanum√©rica (2 ms)
      ‚úì deber√≠a propagar error si el usuario no existe (2 ms)

PASS src/infrastructure/websocket/guards/ws-throttler.guard.spec.ts
  WsThrottlerGuard
    canActivate
      ‚úì should allow first request (1 ms)
      ‚úì should allow requests under the limit (1 ms)
      ‚úì should block request when limit is exceeded (6 ms)
      ‚úì should reset after time window passes (1101 ms)
      ‚úì should track different clients separately (1 ms)
      ‚úì should register cleanup on disconnect (1 ms)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 4 ‚Üí music_server_test_4

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/tracks/infrastructure/persistence/cached-track.repository.spec.ts
  CachedTrackRepository
    findById
      ‚úì should return cached track on cache hit (1 ms)
      ‚úì should fetch from DB and cache on cache miss (1 ms)
      ‚úì should return null if track not found
    findAll
      ‚úì should delegate to base repository without caching (1 ms)
    search
      ‚úì should delegate to base repository without caching (1 ms)
    findByAlbumId
      ‚úì should delegate to base repository without caching
    findByArtistId
      ‚úì should delegate to base repository without caching
    count
      ‚úì should delegate to base repository without caching (1 ms)
    create
      ‚úì should create track without cache invalidation
    update
      ‚úì should update track and invalidate specific cache (1 ms)
      ‚úì should NOT invalidate cache if update fails (1 ms)
    delete
      ‚úì should delete track and invalidate cache
      ‚úì should NOT invalidate cache if delete fails (1 ms)
    cache TTL configuration
      ‚úì should use default TTL from environment (1 ms)

[95m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [95m  DEBUG[39m [38;5;3m[WsJwtGuard] [39m[95m‚úÖ User user-123 authenticated via WebSocket[39m
[95m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [95m  DEBUG[39m [38;5;3m[WsJwtGuard] [39m[95m‚úÖ User user-456 authenticated via WebSocket[39m
[95m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [95m  DEBUG[39m [38;5;3m[WsJwtGuard] [39m[95m‚úÖ User user-789 authenticated via WebSocket[39m
[33m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [33m   WARN[39m [38;5;3m[WsJwtGuard] [39m[33m‚ùå WebSocket authentication failed: No token provided[39m
[33m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [33m   WARN[39m [38;5;3m[WsJwtGuard] [39m[33m‚ùå WebSocket authentication failed: No token provided[39m
[33m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [33m   WARN[39m [38;5;3m[WsJwtGuard] [39m[33m‚ùå WebSocket authentication failed: Invalid token[39m
[33m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [33m   WARN[39m [38;5;3m[WsJwtGuard] [39m[33m‚ùå WebSocket authentication failed: Invalid token[39m
[33m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [33m   WARN[39m [38;5;3m[WsJwtGuard] [39m[33m‚ùå WebSocket authentication failed: Token expired[39m
[95m[Nest] 20343  - [39m11/17/2025, 3:31:41 PM [95m  DEBUG[39m [38;5;3m[WsJwtGuard] [39m[95m‚úÖ User user-999 authenticated via WebSocket[39m
PASS src/infrastructure/websocket/guards/ws-jwt.guard.spec.ts
  WsJwtGuard
    canActivate
      ‚úì should allow connection with valid token from query param (2 ms)
      ‚úì should allow connection with valid token from auth object
      ‚úì should allow connection with valid token from Authorization header (1 ms)
      ‚úì should reject connection without token (12 ms)
      ‚úì should reject connection with invalid token (1 ms)
      ‚úì should reject connection with expired token (1 ms)
      ‚úì should handle array of tokens in query param (1 ms)

[31m[Nest] 20345  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[AdminSettingsController] [39m[31mError retrieving settings: Database error[39m
Error: Database error
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.spec.ts:68:49)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20345  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[AdminSettingsController] [39m[31mError retrieving settings for category test: Database error[39m
Error: Database error
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.spec.ts:105:56)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20345  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[AdminSettingsController] [39m[31mError retrieving setting nonexistent: Setting with key nonexistent not found[39m
BadRequestException: Setting with key nonexistent not found
    at AdminSettingsController.getSetting (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.ts:183:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.spec.ts:130:7)
[31m[Nest] 20345  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[AdminSettingsController] [39m[31mError retrieving setting nonexistent: Setting with key nonexistent not found[39m
BadRequestException: Setting with key nonexistent not found
    at AdminSettingsController.getSetting (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.ts:183:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.spec.ts:131:7)
[31m[Nest] 20345  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[AdminSettingsController] [39m[31mError retrieving setting test.key: Database error[39m
Error: Database error
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.spec.ts:138:49)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20345  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[AdminSettingsController] [39m[31mError updating setting nonexistent: Setting with key nonexistent not found[39m
BadRequestException: Setting with key nonexistent not found
    at AdminSettingsController.updateSetting (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.ts:241:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.spec.ts:173:7)
[31m[Nest] 20345  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[AdminSettingsController] [39m[31mError updating setting test.key: Database error[39m
Error: Database error
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.spec.ts:181:48)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20345  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[AdminSettingsController] [39m[31mError validating API key for lastfm: Network error[39m
Error: Network error
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.spec.ts:249:56)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20345  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[AdminSettingsController] [39m[31mError deleting setting nonexistent: Setting with key nonexistent not found[39m
BadRequestException: Setting with key nonexistent not found
    at AdminSettingsController.deleteSetting (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.ts:382:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.spec.ts:290:7)
[31m[Nest] 20345  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[AdminSettingsController] [39m[31mError deleting setting test.key: Database error[39m
Error: Database error
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.spec.ts:296:48)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
[31m[Nest] 20345  - [39m11/17/2025, 3:31:41 PM [31m  ERROR[39m [38;5;3m[AdminSettingsController] [39m[31mError clearing cache: Cache error[39m
Error: Cache error
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.spec.ts:322:15)
    at /home/user/echo/node_modules/.pnpm/jest-mock@29.7.0/node_modules/jest-mock/build/index.js:397:39
    at Object.<anonymous> (/home/user/echo/node_modules/.pnpm/jest-mock@29.7.0/node_modules/jest-mock/build/index.js:404:13)
    at Object.mockConstructor [as clearCache] (/home/user/echo/node_modules/.pnpm/jest-mock@29.7.0/node_modules/jest-mock/build/index.js:148:19)
    at AdminSettingsController.clearCache (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.ts:427:28)
    at Object.<anonymous> (/home/user/echo/server/src/features/external-metadata/presentation/admin-settings.controller.spec.ts:326:31)
    at Promise.then.completed (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:298:28)
    at new Promise (<anonymous>)
    at callAsyncCircusFn (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/utils.js:231:10)
    at _callCircusTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:316:40)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at _runTest (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:252:3)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:126:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at _runTestsForDescribeBlock (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:121:9)
    at run (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/run.js:71:3)
    at runAndTransformResultsToJestFormat (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
    at jestAdapter (/home/user/echo/node_modules/.pnpm/jest-circus@29.7.0/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
    at runTestInternal (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:367:16)
    at runTest (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/runTest.js:444:34)
    at Object.worker (/home/user/echo/node_modules/.pnpm/jest-runner@29.7.0/node_modules/jest-runner/build/testWorker.js:106:12)
PASS src/features/external-metadata/presentation/admin-settings.controller.spec.ts
  AdminSettingsController
    getAllSettings
      ‚úì deber√≠a retornar todas las configuraciones (5 ms)
      ‚úì deber√≠a propagar errores del servicio (14 ms)
    getSettingsByCategory
      ‚úì deber√≠a retornar configuraciones de una categor√≠a (2 ms)
      ‚úì deber√≠a retornar array vac√≠o si no hay configuraciones (2 ms)
      ‚úì deber√≠a propagar errores del servicio (2 ms)
    getSetting
      ‚úì deber√≠a retornar una configuraci√≥n espec√≠fica (2 ms)
      ‚úì deber√≠a lanzar BadRequestException si no existe (7 ms)
      ‚úì deber√≠a propagar errores del servicio (2 ms)
    updateSetting
      ‚úì deber√≠a actualizar una configuraci√≥n (3 ms)
      ‚úì deber√≠a lanzar BadRequestException si setting no existe (2 ms)
      ‚úì deber√≠a propagar errores del servicio (3 ms)
    validateApiKey
      ‚úì deber√≠a validar API key de Last.fm correctamente (2 ms)
      ‚úì deber√≠a retornar false para API key inv√°lida (1 ms)
      ‚úì deber√≠a validar API key de Fanart.tv (2 ms)
      ‚úì deber√≠a manejar errores de validaci√≥n (2 ms)
    deleteSetting
      ‚úì deber√≠a eliminar una configuraci√≥n (2 ms)
      ‚úì deber√≠a lanzar BadRequestException si setting no existe (1 ms)
      ‚úì deber√≠a propagar errores del servicio (1 ms)
    clearCache
      ‚úì deber√≠a limpiar el cache correctamente (2 ms)
      ‚úì deber√≠a manejar errores al limpiar cache (2 ms)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/streaming/domain/use-cases/stream-track/stream-track.use-case.spec.ts
  StreamTrackUseCase
    execute
      ‚úì deber√≠a retornar metadata del track para streaming (5 ms)
      ‚úì deber√≠a lanzar NotFoundException si trackId est√° vac√≠o (16 ms)
      ‚úì deber√≠a lanzar NotFoundException si trackId es solo espacios (2 ms)
      ‚úì deber√≠a lanzar NotFoundException si el track no existe (1 ms)
      ‚úì deber√≠a lanzar NotFoundException si el track no tiene path (2 ms)
      ‚úì deber√≠a lanzar NotFoundException si el archivo no existe (1 ms)
      ‚úì deber√≠a lanzar NotFoundException si el path no es un archivo (2 ms)
      ‚úì deber√≠a detectar MIME type para MP3 (1 ms)
      ‚úì deber√≠a detectar MIME type para FLAC (1 ms)
      ‚úì deber√≠a usar audio/mpeg por defecto para extensiones desconocidas (1 ms)
      ‚úì deber√≠a extraer correctamente el nombre del archivo (1 ms)

  console.log
    üß™ Test Worker 3 ‚Üí music_server_test_3

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 4 ‚Üí music_server_test_4

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/artists/domain/use-cases/get-artist/get-artist.use-case.spec.ts
  GetArtistUseCase
    execute
      ‚úì deber√≠a retornar un artista por su ID (4 ms)
      ‚úì deber√≠a lanzar NotFoundError si el artista no existe (7 ms)
      ‚úì deber√≠a lanzar NotFoundError si el ID est√° vac√≠o (4 ms)
      ‚úì deber√≠a lanzar NotFoundError si el ID es solo espacios (1 ms)
      ‚úì deber√≠a manejar artistas sin campos opcionales (2 ms)
      ‚úì deber√≠a retornar artista con todos los campos completos (1 ms)

[31m[Nest] 20344  - [39m11/17/2025, 3:31:42 PM [31m  ERROR[39m [38;5;3m[SettingsService] [39m[31mLast.fm API key validation failed: Network error[39m
PASS src/features/external-metadata/infrastructure/services/settings.service.spec.ts
  SettingsService
    get
      ‚úì deber√≠a retornar valor del cache si existe (4 ms)
      ‚úì deber√≠a consultar la BD si no est√° en cache (2 ms)
      ‚úì deber√≠a retornar defaultValue si no existe el setting (1 ms)
      ‚úì deber√≠a retornar null si no existe y no hay defaultValue (1 ms)
    getBoolean
      ‚úì deber√≠a convertir "true" a boolean true (2 ms)
      ‚úì deber√≠a convertir "false" a boolean false (2 ms)
      ‚úì deber√≠a retornar defaultValue si no existe (1 ms)
    getNumber
      ‚úì deber√≠a convertir string a n√∫mero (2 ms)
      ‚úì deber√≠a retornar defaultValue si no existe (1 ms)
    getString
      ‚úì deber√≠a retornar valor como string (1 ms)
      ‚úì deber√≠a retornar defaultValue si no existe (1 ms)
    set
      ‚úì deber√≠a actualizar un setting y su cache (1 ms)
      ‚úì deber√≠a convertir boolean a string (2 ms)
      ‚úì deber√≠a convertir n√∫mero a string (1 ms)
    setMultiple
      ‚úì deber√≠a actualizar m√∫ltiples settings (2 ms)
    getCategory
      ‚úì deber√≠a retornar todas las settings de una categor√≠a (2 ms)
    validateApiKey
      ‚úì deber√≠a retornar false si API key est√° vac√≠a (1 ms)
      ‚úì deber√≠a validar Last.fm API key correctamente (2 ms)
      ‚úì deber√≠a retornar false si Last.fm API key es inv√°lida (1 ms)
      ‚úì deber√≠a validar Fanart.tv API key correctamente (2 ms)
      ‚úì deber√≠a retornar false si Fanart.tv API key es inv√°lida (1 ms)
      ‚úì deber√≠a manejar errores de red (2 ms)
    clearCache
      ‚úì deber√≠a limpiar el cache (3 ms)
    update
      ‚úì deber√≠a actualizar setting y invalidar cache (1 ms)
    delete
      ‚úì deber√≠a eliminar setting y invalidar cache (2 ms)

PASS src/features/admin/domain/use-cases/list-users/list-users.use-case.spec.ts
  ListUsersUseCase
    execute
      ‚úì deber√≠a listar usuarios con paginaci√≥n por defecto (4 ms)
      ‚úì deber√≠a respetar par√°metros de paginaci√≥n personalizados (2 ms)
      ‚úì deber√≠a manejar lista vac√≠a de usuarios (2 ms)
      ‚úì deber√≠a mapear correctamente usuarios sin email ni lastLoginAt (1 ms)

PASS src/features/tracks/domain/use-cases/search-tracks/search-tracks.use-case.spec.ts
  SearchTracksUseCase
    execute
      ‚úì deber√≠a buscar tracks por query (4 ms)
      ‚úì deber√≠a lanzar ValidationError si query est√° vac√≠o (15 ms)
      ‚úì deber√≠a lanzar ValidationError si query es solo espacios (2 ms)
      ‚úì deber√≠a lanzar ValidationError si query tiene menos de 2 caracteres (2 ms)
      ‚úì deber√≠a limpiar espacios del query antes de buscar (1 ms)
      ‚úì deber√≠a limitar take a m√°ximo 100 (1 ms)
      ‚úì deber√≠a convertir skip negativo a 0 (2 ms)
      ‚úì deber√≠a convertir take menor a 1 a 1 (1 ms)
      ‚úì deber√≠a establecer hasMore correctamente (1 ms)
      ‚úì deber√≠a establecer hasMore en false cuando no hay m√°s resultados (1 ms)
      ‚úì deber√≠a manejar resultado vac√≠o (2 ms)
      ‚úì deber√≠a mapear correctamente todos los campos de los tracks (2 ms)
      ‚úì deber√≠a aceptar query con exactamente 2 caracteres (2 ms)
      ‚úì deber√≠a manejar queries con caracteres especiales (1 ms)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 3 ‚Üí music_server_test_3

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 4 ‚Üí music_server_test_4

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/albums/domain/use-cases/search-albums/search-albums.use-case.spec.ts
  SearchAlbumsUseCase
    execute
      ‚úì deber√≠a buscar √°lbumes por query (4 ms)
      ‚úì deber√≠a lanzar ValidationError si query est√° vac√≠o (13 ms)
      ‚úì deber√≠a lanzar ValidationError si query es solo espacios (2 ms)
      ‚úì deber√≠a lanzar ValidationError si query tiene menos de 2 caracteres (2 ms)
      ‚úì deber√≠a limpiar espacios del query antes de buscar (1 ms)
      ‚úì deber√≠a limitar take a m√°ximo 100 (1 ms)
      ‚úì deber√≠a convertir skip negativo a 0 (1 ms)
      ‚úì deber√≠a convertir take menor a 1 a 1 (1 ms)
      ‚úì deber√≠a establecer hasMore correctamente (1 ms)
      ‚úì deber√≠a establecer hasMore en false cuando no hay m√°s resultados (2 ms)
      ‚úì deber√≠a manejar resultado vac√≠o (1 ms)
      ‚úì deber√≠a mapear correctamente todos los campos de los √°lbumes (2 ms)
      ‚úì deber√≠a aceptar query con exactamente 2 caracteres (1 ms)
      ‚úì deber√≠a manejar queries con caracteres especiales (2 ms)

PASS src/features/tracks/domain/use-cases/get-track/get-track.use-case.spec.ts
  GetTrackUseCase
    execute
      ‚úì deber√≠a retornar un track por su ID (4 ms)
      ‚úì deber√≠a lanzar NotFoundError si el track no existe (8 ms)
      ‚úì deber√≠a lanzar NotFoundError si el ID est√° vac√≠o (5 ms)
      ‚úì deber√≠a lanzar NotFoundError si el ID es solo espacios (1 ms)
      ‚úì deber√≠a manejar tracks sin campos opcionales (2 ms)
      ‚úì deber√≠a manejar tracks de compilaci√≥n (1 ms)

PASS src/features/scanner/domain/use-cases/get-scan-status/get-scan-status.use-case.spec.ts
  GetScanStatusUseCase
    ‚úì should be defined (4 ms)
    execute
      ‚úì should return scan status for existing scan (5 ms)
      ‚úì should throw NotFoundError if scan does not exist (6 ms)
      ‚úì should throw NotFoundError for empty/invalid id (5 ms)
      ‚úì should return scan with null duration if not finished (1 ms)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/artists/domain/use-cases/search-artists/search-artists.use-case.spec.ts
  SearchArtistsUseCase
    execute
      ‚úì deber√≠a buscar artistas por query (8 ms)
      ‚úì deber√≠a lanzar ValidationError si query est√° vac√≠o (12 ms)
      ‚úì deber√≠a lanzar ValidationError si query es solo espacios (2 ms)
      ‚úì deber√≠a lanzar ValidationError si query tiene menos de 2 caracteres (1 ms)
      ‚úì deber√≠a limpiar espacios del query antes de buscar (1 ms)
      ‚úì deber√≠a limitar take a m√°ximo 100 (2 ms)
      ‚úì deber√≠a convertir skip negativo a 0 (1 ms)
      ‚úì deber√≠a convertir take menor a 1 a 1 (1 ms)
      ‚úì deber√≠a establecer hasMore correctamente (1 ms)
      ‚úì deber√≠a establecer hasMore en false cuando no hay m√°s resultados (2 ms)
      ‚úì deber√≠a manejar resultado vac√≠o (1 ms)
      ‚úì deber√≠a mapear correctamente todos los campos de los artistas (2 ms)
      ‚úì deber√≠a aceptar query con exactamente 2 caracteres (1 ms)
      ‚úì deber√≠a manejar queries con caracteres especiales (2 ms)

  console.log
    üß™ Test Worker 4 ‚Üí music_server_test_4

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 3 ‚Üí music_server_test_3

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/tracks/domain/use-cases/get-tracks/get-tracks.use-case.spec.ts
  GetTracksUseCase
    execute
      ‚úì deber√≠a retornar lista paginada con valores por defecto (4 ms)
      ‚úì deber√≠a aplicar paginaci√≥n correctamente (1 ms)
      ‚úì deber√≠a limitar take a m√°ximo 100 (1 ms)
      ‚úì deber√≠a establecer hasMore en false cuando no hay m√°s resultados (2 ms)
      ‚úì deber√≠a convertir skip negativo a 0 (1 ms)
      ‚úì deber√≠a convertir take menor a 1 a 1 (1 ms)
      ‚úì deber√≠a manejar resultado vac√≠o (2 ms)
      ‚úì deber√≠a mapear correctamente todos los campos de los tracks (3 ms)
      ‚úì deber√≠a usar valores por defecto si no se provee skip/take (1 ms)

PASS src/features/scanner/domain/use-cases/start-scan/start-scan.use-case.spec.ts
  StartScanUseCase
    execute
      ‚úì should create a scan and enqueue it successfully (5 ms)
      ‚úì should throw error if there is already a running scan (7 ms)
      ‚úì should use default options when none provided (1 ms)
      ‚úì should handle repository create error gracefully (7 ms)
      ‚úì should handle processor enqueue error gracefully (1 ms)
      ‚úì should correctly pass scan options to processor (1 ms)

PASS src/features/albums/domain/use-cases/get-album/get-album.use-case.spec.ts
  GetAlbumUseCase
    execute
      ‚úì deber√≠a retornar un √°lbum por su ID (5 ms)
      ‚úì deber√≠a lanzar NotFoundError si el √°lbum no existe (8 ms)
      ‚úì deber√≠a lanzar NotFoundError si el ID est√° vac√≠o (5 ms)
      ‚úì deber√≠a lanzar NotFoundError si el ID es solo espacios (2 ms)
      ‚úì deber√≠a manejar √°lbumes sin campos opcionales (1 ms)
      ‚úì deber√≠a manejar √°lbumes de compilaci√≥n (1 ms)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/shared/guards/must-change-password.guard.spec.ts
  MustChangePasswordGuard
    canActivate
      ‚úì deber√≠a permitir acceso si mustChangePassword es false (1 ms)
      ‚úì deber√≠a denegar acceso si mustChangePassword es true (10 ms)
      ‚úì deber√≠a permitir acceso a rutas con decorator AllowChangePassword
      ‚úì deber√≠a permitir acceso si no hay usuario (caso edge) (1 ms)
      ‚úì deber√≠a permitir acceso si mustChangePassword es undefined
      ‚úì deber√≠a verificar metadata ALLOW_CHANGE_PASSWORD_KEY (1 ms)

  console.log
    üß™ Test Worker 4 ‚Üí music_server_test_4

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 3 ‚Üí music_server_test_3

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/admin/domain/use-cases/update-user/update-user.use-case.spec.ts
  UpdateUserUseCase
    execute
      ‚úì deber√≠a actualizar el nombre del usuario correctamente (1 ms)
      ‚úì deber√≠a actualizar el email del usuario correctamente (1 ms)
      ‚úì deber√≠a actualizar el rol de admin del usuario
      ‚úì deber√≠a actualizar el estado activo del usuario (1 ms)
      ‚úì deber√≠a actualizar m√∫ltiples campos a la vez
      ‚úì deber√≠a lanzar error si el usuario no existe (14 ms)
      ‚úì deber√≠a lanzar error si el email ya existe en otro usuario (1 ms)
      ‚úì deber√≠a permitir actualizar con el mismo email del usuario (1 ms)
      ‚úì deber√≠a lanzar error si el formato del email es inv√°lido (1 ms)
      ‚úì deber√≠a permitir email vac√≠o (sin validaci√≥n) (1 ms)
      ‚úì no deber√≠a verificar email duplicado si no se est√° cambiando

PASS src/features/artists/infrastructure/persistence/cached-artist.repository.spec.ts
  CachedArtistRepository
    findById
      ‚úì should return cached artist on cache hit (1 ms)
      ‚úì should fetch from DB and cache on cache miss (1 ms)
      ‚úì should return null if artist not found (1 ms)
      ‚úì should handle cache service errors gracefully (11 ms)
    findAll
      ‚úì should delegate to base repository without caching (1 ms)
    search
      ‚úì should delegate to base repository without caching
    count
      ‚úì should delegate to base repository without caching (1 ms)
    create
      ‚úì should create artist without cache invalidation
    update
      ‚úì should update artist and invalidate specific cache (1 ms)
      ‚úì should NOT invalidate cache if update fails (1 ms)
      ‚úì should handle partial updates correctly (3 ms)
    delete
      ‚úì should delete artist and invalidate cache (1 ms)
      ‚úì should NOT invalidate cache if delete fails (1 ms)
    cache TTL configuration
      ‚úì should use longer TTL for artists (7200s default)
    integration scenarios
      ‚úì should handle full CRUD cycle with proper cache management (1 ms)

PASS src/features/albums/domain/use-cases/get-albums/get-albums.use-case.spec.ts
  GetAlbumsUseCase
    execute
      ‚úì deber√≠a retornar lista paginada con valores por defecto (11 ms)
      ‚úì deber√≠a aplicar paginaci√≥n correctamente (2 ms)
      ‚úì deber√≠a limitar take a m√°ximo 100 (1 ms)
      ‚úì deber√≠a establecer hasMore en false cuando no hay m√°s resultados (1 ms)
      ‚úì deber√≠a convertir skip negativo a 0 (1 ms)
      ‚úì deber√≠a convertir take menor a 1 a 1 (1 ms)
      ‚úì deber√≠a manejar resultado vac√≠o (2 ms)
      ‚úì deber√≠a mapear correctamente todos los campos de los √°lbumes (2 ms)
      ‚úì deber√≠a usar valores por defecto si no se provee skip/take (1 ms)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 4 ‚Üí music_server_test_4

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/auth/infrastructure/adapters/jwt.adapter.spec.ts
  JwtAdapter
    generateAccessToken
      ‚úì deber√≠a generar access token v√°lido (1 ms)
    generateRefreshToken
      ‚úì deber√≠a generar refresh token v√°lido (1 ms)
    verifyAccessToken
      ‚úì deber√≠a verificar access token v√°lido
      ‚úì deber√≠a lanzar error si token es inv√°lido (9 ms)

  console.log
    üß™ Test Worker 3 ‚Üí music_server_test_3

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/users/domain/use-cases/change-language/change-language.use-case.spec.ts
  ChangeLanguageUseCase
    execute
      ‚úì deber√≠a cambiar idioma a espa√±ol (1 ms)
      ‚úì deber√≠a cambiar idioma a ingl√©s
      ‚úì deber√≠a permitir establecer el mismo idioma actual (1 ms)
      ‚úì deber√≠a lanzar error si usuario no existe (7 ms)
      ‚úì deber√≠a lanzar error si idioma no es v√°lido (4 ms)
      ‚úì deber√≠a lanzar error para idioma vac√≠o (1 ms)
      ‚úì deber√≠a lanzar error para idioma con may√∫sculas
      ‚úì deber√≠a validar idioma ANTES de verificar si usuario existe (1 ms)
      ‚úì deber√≠a rechazar c√≥digos de idioma con regi√≥n (1 ms)
      ‚úì NO deber√≠a retornar nada (void) (1 ms)
      ‚úì deber√≠a funcionar para usuarios inactivos

PASS src/features/users/domain/use-cases/update-profile/update-profile.use-case.spec.ts
  UpdateProfileUseCase
    execute
      ‚úì deber√≠a actualizar nombre y email correctamente (2 ms)
      ‚úì deber√≠a actualizar solo el nombre (1 ms)
      ‚úì deber√≠a actualizar solo el email (1 ms)
      ‚úì deber√≠a lanzar error si usuario no existe (7 ms)
      ‚úì deber√≠a lanzar error si nuevo email ya est√° en uso (1 ms)
      ‚úì NO deber√≠a lanzar error si el nuevo email es el mismo que el actual (1 ms)
      ‚úì NO deber√≠a incluir campos sensibles en la respuesta (1 ms)
      ‚úì deber√≠a preservar username (no debe cambiar) (1 ms)

PASS src/features/playlists/domain/use-cases/create-playlist/create-playlist.use-case.spec.ts
  CreatePlaylistUseCase
    execute
      ‚úì should create a new playlist successfully (2 ms)
      ‚úì should create a public playlist
      ‚úì should default to private playlist if public not specified (1 ms)
      ‚úì should trim whitespace from name
      ‚úì should throw error if name is empty (12 ms)
      ‚úì should throw error if name is only whitespace (1 ms)
      ‚úì should throw error if ownerId is empty (1 ms)
      ‚úì should handle optional fields
      ‚úì should initialize playlist with zero tracks and duration (1 ms)

  console.log
    üß™ Test Worker 4 ‚Üí music_server_test_4

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/auth/domain/use-cases/refresh-token/refresh-token.use-case.spec.ts
  RefreshTokenUseCase
    execute
      ‚úì deber√≠a generar nuevos tokens con refresh token v√°lido (2 ms)
      ‚úì deber√≠a lanzar error si refresh token es inv√°lido (8 ms)
      ‚úì deber√≠a lanzar error si refresh token est√° expirado (1 ms)
      ‚úì deber√≠a lanzar error si usuario no existe (1 ms)
      ‚úì deber√≠a lanzar error si usuario est√° inactivo (1 ms)
      ‚úì deber√≠a lanzar error si refresh token est√° vac√≠o (1 ms)
      ‚úì deber√≠a funcionar para usuarios admin (1 ms)
      ‚úì deber√≠a generar tokens diferentes en cada llamada

PASS src/features/users/domain/use-cases/change-password/change-password.use-case.spec.ts
  ChangePasswordUseCase
    execute
      ‚úì deber√≠a cambiar contrase√±a correctamente (1 ms)
      ‚úì deber√≠a quitar mustChangePassword si era primer login
      ‚úì NO deber√≠a llamar updatePartial si mustChangePassword ya era false
      ‚úì deber√≠a lanzar error si nueva contrase√±a es muy corta (15 ms)
      ‚úì deber√≠a lanzar error si usuario no existe
      ‚úì deber√≠a lanzar error si contrase√±a actual es incorrecta (1 ms)
      ‚úì deber√≠a lanzar error si nueva contrase√±a es igual a la actual (1 ms)
      ‚úì deber√≠a permitir contrase√±a con exactamente 8 caracteres

PASS src/shared/guards/jwt-auth.guard.spec.ts
  AdminGuard
    canActivate
      ‚úì deber√≠a permitir acceso si el usuario es admin (1 ms)
      ‚úì deber√≠a denegar acceso si el usuario NO es admin (13 ms)
      ‚úì deber√≠a denegar acceso si no hay usuario en el request (1 ms)
      ‚úì deber√≠a denegar acceso si user.isAdmin es undefined
      ‚úì deber√≠a denegar acceso si user.isAdmin es null (1 ms)
      ‚úì deber√≠a denegar acceso si user.isAdmin es false expl√≠citamente (1 ms)

  console.log
    üß™ Test Worker 3 ‚Üí music_server_test_3

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/users/domain/use-cases/change-theme/change-theme.use-case.spec.ts
  ChangeThemeUseCase
    execute
      ‚úì deber√≠a cambiar tema a dark (1 ms)
      ‚úì deber√≠a cambiar tema a light (1 ms)
      ‚úì deber√≠a permitir establecer el mismo tema actual
      ‚úì deber√≠a lanzar error si usuario no existe (8 ms)
      ‚úì deber√≠a lanzar error si tema no es v√°lido (4 ms)
      ‚úì deber√≠a lanzar error para tema vac√≠o (1 ms)
      ‚úì deber√≠a lanzar error para tema con may√∫sculas (1 ms)
      ‚úì deber√≠a validar tema ANTES de verificar si usuario existe (1 ms)
      ‚úì NO deber√≠a retornar nada (void)
      ‚úì deber√≠a funcionar para usuarios inactivos

  console.log
    üß™ Test Worker 4 ‚Üí music_server_test_4

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/playlists/domain/use-cases/get-playlists/get-playlists.use-case.spec.ts
  GetPlaylistsUseCase
    execute
      ‚úì should get playlists by ownerId (2 ms)
      ‚úì should get public playlists only (1 ms)
      ‚úì should use default pagination values (1 ms)
      ‚úì should handle custom pagination
      ‚úì should throw error if skip is negative (12 ms)
      ‚úì should throw error if take is zero (1 ms)
      ‚úì should throw error if take exceeds 100 (2 ms)
      ‚úì should throw error if no filter specified (1 ms)
      ‚úì should map playlists to output format correctly
      ‚úì should handle empty result (1 ms)

PASS src/features/admin/domain/use-cases/reset-user-password/reset-user-password.use-case.spec.ts
  ResetUserPasswordUseCase
    execute
      ‚úì deber√≠a resetear la contrase√±a del usuario correctamente (2 ms)
      ‚úì deber√≠a generar una contrase√±a temporal alfanum√©rica de 8 caracteres (1 ms)
      ‚úì deber√≠a marcar mustChangePassword como true
      ‚úì deber√≠a funcionar para usuarios admin (1 ms)
      ‚úì deber√≠a lanzar error si el usuario no existe (9 ms)
      ‚úì deber√≠a hashear la contrase√±a temporal antes de guardarla (1 ms)
      ‚úì deber√≠a generar contrase√±as diferentes en cada ejecuci√≥n (1 ms)
      ‚úì deber√≠a funcionar para usuarios inactivos

PASS src/features/auth/domain/use-cases/login/loginUseCase.spec.ts
  LoginUseCase
    execute
      ‚úì deber√≠a loguear un usuario v√°lido (2 ms)
      ‚úì deber√≠a lanzar error si username y password est√°n vac√≠os (10 ms)
      ‚úì deber√≠a lanzar error si username falta (1 ms)
      ‚úì deber√≠a lanzar error si password falta
      ‚úì deber√≠a lanzar error si usuario no existe (1 ms)
      ‚úì deber√≠a lanzar error si usuario est√° inactivo
      ‚úì deber√≠a lanzar error si password es incorrecto
      ‚úì deber√≠a retornar sin email si el usuario no tiene
      ‚úì deber√≠a generar tokens correctamente (1 ms)

  console.log
    üß™ Test Worker 3 ‚Üí music_server_test_3

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/admin/domain/use-cases/create-user/create-user.use-case.spec.ts
  CreateUserUseCase
    execute
      ‚úì deber√≠a crear un usuario correctamente (2 ms)
      ‚úì deber√≠a crear un usuario admin
      ‚úì deber√≠a crear usuario sin email (1 ms)
      ‚úì deber√≠a lanzar error si username es muy corto (11 ms)
      ‚úì deber√≠a lanzar error si username ya existe
      ‚úì deber√≠a lanzar error si email ya existe (1 ms)
      ‚úì deber√≠a generar contrase√±a temporal de 6 d√≠gitos

  console.log
    üß™ Test Worker 4 ‚Üí music_server_test_4

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/auth/infrastructure/adapters/bcrypt.adapter.spec.ts
  BcryptAdapter
    hash
      ‚úì deber√≠a hashear una contrase√±a (1 ms)
      ‚úì deber√≠a usar el n√∫mero correcto de rounds (1 ms)
    compare
      ‚úì deber√≠a retornar true si passwords coinciden
      ‚úì deber√≠a retornar false si passwords no coinciden
      ‚úì deber√≠a manejar errores de bcrypt (6 ms)

PASS src/features/auth/domain/entities/user.entity.spec.ts
  User Entity
    create
      ‚úì deber√≠a crear un nuevo usuario (1 ms)
      ‚úì deber√≠a generar IDs √∫nicos para diferentes usuarios
      ‚úì deber√≠a tener isAdmin en false por defecto
      ‚úì deber√≠a permitir crear sin email
    reconstruct
      ‚úì deber√≠a reconstruir un usuario desde BD (1 ms)
      ‚úì deber√≠a preservar las fechas al reconstruir
    getters
      ‚úì deber√≠a retornar todas las propiedades (1 ms)
      ‚úì deber√≠a retornar undefined para email si no existe
      ‚úì deber√≠a retornar undefined para name si no existe
    toPrimitives
      ‚úì deber√≠a convertir a objeto primitivo (1 ms)
      ‚úì deber√≠a retornar una copia, no referencia (1 ms)
      ‚úì deber√≠a poder reconstruir desde toPrimitives
    immutability
      ‚úì no deber√≠a permitir modificar propiedades directamente (11 ms)

PASS src/shared/utils/password.util.spec.ts
  PasswordUtil
    generateTemporaryPassword
      ‚úì deber√≠a generar una contrase√±a de exactamente 8 caracteres (1 ms)
      ‚úì deber√≠a generar solo caracteres alfanum√©ricos
      ‚úì deber√≠a contener al menos una letra may√∫scula (1 ms)
      ‚úì deber√≠a contener al menos una letra min√∫scula (1 ms)
      ‚úì deber√≠a contener al menos un n√∫mero
      ‚úì NO deber√≠a contener caracteres confusos (I, O, l, 0, 1) (25 ms)
      ‚úì deber√≠a generar contrase√±as diferentes en cada llamada
      ‚úì deber√≠a generar contrase√±as con alta entrop√≠a (100 contrase√±as √∫nicas) (2 ms)
      ‚úì deber√≠a tener la estructura esperada: 1 may√∫scula + 1 min√∫scula + 1 n√∫mero + 5 aleatorios (13 ms)
      ‚úì deber√≠a usar solo caracteres seguros (sin I, O, l, o, 0, 1) (33 ms)
      ‚úì deber√≠a mantener consistencia en el formato: alfanum√©rico de 8 caracteres (16 ms)

  console.log
    üß™ Test Worker 1 ‚Üí music_server_test_1

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

PASS src/features/scanner/domain/entities/library-scan.entity.spec.ts
  LibraryScan Entity
    create
      ‚úì should create a new LibraryScan with auto-generated id (1 ms)
    fromPrimitives
      ‚úì should reconstruct LibraryScan from primitives (3 ms)
    status methods
      ‚úì should correctly identify pending scan
      ‚úì should correctly identify running scan (1 ms)
      ‚úì should correctly identify completed scan
      ‚úì should correctly identify failed scan
    getTotalChanges
      ‚úì should calculate total changes correctly
      ‚úì should return 0 for scan with no changes
    getDuration
      ‚úì should return null if scan is not finished
      ‚úì should calculate duration correctly for finished scan
    toPrimitives
      ‚úì should convert entity to primitives (1 ms)

PASS src/shared/guards/admin.guard.spec.ts
  AdminGuard
    canActivate
      ‚úì deber√≠a permitir acceso si el usuario es admin (1 ms)
      ‚úì deber√≠a denegar acceso si el usuario NO es admin (8 ms)
      ‚úì deber√≠a denegar acceso si no hay usuario en el request
      ‚úì deber√≠a denegar acceso si user.isAdmin es undefined (1 ms)
      ‚úì deber√≠a denegar acceso si user.isAdmin es null
      ‚úì deber√≠a denegar acceso si user.isAdmin es false expl√≠citamente (1 ms)

  console.log
    üß™ Test Worker 2 ‚Üí music_server_test_2

      at Object.<anonymous> (../test/setup-test-db.ts:10:9)

FAIL src/features/recommendations/domain/services/wave-mix.service.spec.ts
  ‚óè Test suite failed to run

    Configuration error:

    Could not locate module @features/external-metadata/infrastructure/image-download.service mapped as:
    /home/user/echo/server/src/features/$1.

    Please check your configuration for these entries:
    {
      "moduleNameMapper": {
        "/^@features\/(.*)$/": "/home/user/echo/server/src/features/$1"
      },
      "resolver": undefined
    }

       8 | import { RedisService } from '@infrastructure/cache/redis.service';
       9 | import { StorageService } from '@features/external-metadata/infrastructure/services/storage.service';
    > 10 | import { ImageDownloadService } from '@features/external-metadata/infrastructure/image-download.service';
         | ^
      11 |
      12 | describe('WaveMixService', () => {
      13 |   let service: WaveMixService;

      at createNoMappedModuleFoundError (../../node_modules/.pnpm/jest-resolve@29.7.0/node_modules/jest-resolve/build/resolver.js:759:17)
      at Object.<anonymous> (features/recommendations/domain/services/wave-mix.service.spec.ts:10:1)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Summary of all failing tests
FAIL features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts
  ‚óè DeleteUserUseCase ‚Ä∫ execute ‚Ä∫ deber√≠a permitir desactivar un admin si hay m√°s admins

    Cannot delete system administrator

      34 |     // 3. No permitir eliminar al system admin
      35 |     if (isSystemAdmin) {
    > 36 |       throw new ValidationError('Cannot delete system administrator');
         |             ^
      37 |     }
      38 |
      39 |     // 4. Prevenir eliminaci√≥n del usuario actual si es el √∫nico admin

      at DeleteUserUseCase.execute (features/admin/domain/use-cases/delete-user/delete-user.use-case.ts:36:13)
      at Object.<anonymous> (features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts:118:22)

  ‚óè DeleteUserUseCase ‚Ä∫ execute ‚Ä∫ deber√≠a lanzar error si intenta desactivar el √∫ltimo admin

    expect(received).rejects.toThrow(expected)

    Expected substring: "Cannot delete the last admin user"
    Received message:   "Cannot delete system administrator"

          34 |     // 3. No permitir eliminar al system admin
          35 |     if (isSystemAdmin) {
        > 36 |       throw new ValidationError('Cannot delete system administrator');
             |             ^
          37 |     }
          38 |
          39 |     // 4. Prevenir eliminaci√≥n del usuario actual si es el √∫nico admin

      at DeleteUserUseCase.execute (features/admin/domain/use-cases/delete-user/delete-user.use-case.ts:36:13)
      at Object.<anonymous> (features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts:184:7)
      at Object.toThrow (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts:184:52)

  ‚óè DeleteUserUseCase ‚Ä∫ execute ‚Ä∫ no deber√≠a verificar admins si el usuario a desactivar no es admin

    expect(jest.fn()).not.toHaveBeenCalled()

    Expected number of calls: 0
    Received number of calls: 1

    1: 0, 1000

      271 |
      272 |       // Assert
    > 273 |       expect(mockUserRepository.findAll).not.toHaveBeenCalled();
          |                                              ^
      274 |     });
      275 |
      276 |     it('deber√≠a contar solo admins activos al verificar el √∫ltimo admin', async () => {

      at Object.<anonymous> (features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts:273:46)

  ‚óè DeleteUserUseCase ‚Ä∫ execute ‚Ä∫ deber√≠a contar solo admins activos al verificar el √∫ltimo admin

    expect(received).rejects.toThrow(expected)

    Expected substring: "Cannot delete the last admin user"
    Received message:   "Cannot delete system administrator"

          34 |     // 3. No permitir eliminar al system admin
          35 |     if (isSystemAdmin) {
        > 36 |       throw new ValidationError('Cannot delete system administrator');
             |             ^
          37 |     }
          38 |
          39 |     // 4. Prevenir eliminaci√≥n del usuario actual si es el √∫nico admin

      at DeleteUserUseCase.execute (features/admin/domain/use-cases/delete-user/delete-user.use-case.ts:36:13)
      at Object.<anonymous> (features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts:319:7)
      at Object.toThrow (../../node_modules/.pnpm/expect@29.7.0/node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (features/admin/domain/use-cases/delete-user/delete-user.use-case.spec.ts:319:52)

FAIL features/external-metadata/infrastructure/services/cleanup.service.spec.ts
  ‚óè CleanupService ‚Ä∫ verifyIntegrity ‚Ä∫ deber√≠a verificar integridad de archivos referenciados

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 5

      306 |
      307 |       // Assert
    > 308 |       expect(result.totalChecked).toBe(3); // 2 artist images + 1 album cover
          |                                   ^
      309 |       expect(result.missing).toEqual([]);
      310 |       expect(result.errors).toEqual([]);
      311 |     });

      at Object.<anonymous> (features/external-metadata/infrastructure/services/cleanup.service.spec.ts:308:35)

  ‚óè CleanupService ‚Ä∫ verifyIntegrity ‚Ä∫ deber√≠a detectar archivos faltantes

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 4

      335 |
      336 |       // Assert
    > 337 |       expect(result.totalChecked).toBe(1);
          |                                   ^
      338 |       expect(result.missing.length).toBe(1);
      339 |       expect(result.missing[0]).toContain('Artist 1');
      340 |     });

      at Object.<anonymous> (features/external-metadata/infrastructure/services/cleanup.service.spec.ts:337:35)

FAIL features/users/presentation/users.controller.spec.ts
  ‚óè UsersController ‚Ä∫ PUT /users/profile - updateProfile ‚Ä∫ deber√≠a actualizar el perfil correctamente

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 2

    - Object {
    + UserResponseDto {
    +   "avatarUrl": "/api/images/users/user-123/avatar",
        "email": "updated@test.com",
        "id": "user-123",
        "name": "Updated Name",
        "username": "testuser",
      }

      178 |         email: 'updated@test.com',
      179 |       });
    > 180 |       expect(result).toEqual(useCaseResponse);
          |                      ^
      181 |     });
      182 |
      183 |     it('deber√≠a actualizar solo el nombre', async () => {

      at Object.<anonymous> (features/users/presentation/users.controller.spec.ts:180:22)

FAIL features/recommendations/domain/services/wave-mix.service.spec.ts
  ‚óè Test suite failed to run

    Configuration error:

    Could not locate module @features/external-metadata/infrastructure/image-download.service mapped as:
    /home/user/echo/server/src/features/$1.

    Please check your configuration for these entries:
    {
      "moduleNameMapper": {
        "/^@features\/(.*)$/": "/home/user/echo/server/src/features/$1"
      },
      "resolver": undefined
    }

       8 | import { RedisService } from '@infrastructure/cache/redis.service';
       9 | import { StorageService } from '@features/external-metadata/infrastructure/services/storage.service';
    > 10 | import { ImageDownloadService } from '@features/external-metadata/infrastructure/image-download.service';
         | ^
      11 |
      12 | describe('WaveMixService', () => {
      13 |   let service: WaveMixService;

      at createNoMappedModuleFoundError (../../node_modules/.pnpm/jest-resolve@29.7.0/node_modules/jest-resolve/build/resolver.js:759:17)
      at Object.<anonymous> (features/recommendations/domain/services/wave-mix.service.spec.ts:10:1)


Test Suites: 4 failed, 2 skipped, 45 passed, 49 of 51 total
Tests:       7 failed, 20 skipped, 480 passed, 507 total
Snapshots:   0 total
Time:        16.435 s
Ran all test suites.
