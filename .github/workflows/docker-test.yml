name: Docker Build Test

on:
  pull_request:
    paths:
      - 'Dockerfile'
      - 'docker-compose*.yml'
      - '.dockerignore'
      - 'api/scripts/docker-entrypoint.sh'
      - '.github/workflows/docker-*.yml'

jobs:
  test-build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (test only)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: echo-music-server:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker Compose (Development)
        run: |
          # Development compose should work without any .env file
          docker compose -f docker-compose.dev.yml config

      - name: Test Docker Compose (Production - Jellyfin-style)
        run: |
          # Production compose should work WITHOUT .env (auto-generates secrets)
          docker compose config

      - name: Smoke test - Container starts correctly
        run: |
          # Verificar que el contenedor construido puede arrancar
          # Usamos --init y timeout para evitar que el test cuelgue
          echo "üß™ Testing container startup..."

          # Crear red y servicios de dependencia m√≠nimos para el test
          docker network create echo-test-net || true

          # Iniciar PostgreSQL temporal
          docker run -d --name test-postgres \
            --network echo-test-net \
            -e POSTGRES_USER=test \
            -e POSTGRES_PASSWORD=test \
            -e POSTGRES_DB=test \
            postgres:16-alpine

          # Iniciar Redis temporal
          docker run -d --name test-redis \
            --network echo-test-net \
            redis:7-alpine redis-server

          # Esperar a que los servicios est√©n listos
          sleep 5

          # Ejecutar el contenedor de echo con timeout
          # Solo verificamos que arranca y responde, no que funcione completamente
          docker run -d --name test-echo \
            --network echo-test-net \
            -e DATABASE_URL=postgresql://test:test@test-postgres:5432/test \
            -e REDIS_HOST=test-redis \
            -e NODE_ENV=production \
            echo-music-server:test

          # Dar tiempo al contenedor para inicializar
          echo "‚è≥ Waiting for container to initialize..."
          sleep 15

          # Verificar que el contenedor sigue corriendo (no crashe√≥)
          if docker ps | grep -q test-echo; then
            echo "‚úÖ Container is running"
            docker logs test-echo --tail 20
          else
            echo "‚ùå Container failed to start"
            docker logs test-echo
            exit 1
          fi

          # Cleanup
          docker stop test-echo test-postgres test-redis || true
          docker rm test-echo test-postgres test-redis || true
          docker network rm echo-test-net || true
