# =============================================
# Echo Music Server
# =============================================
#
# INSTALACIÓN RÁPIDA:
#
#   1. Configura tus rutas de música abajo (busca ">>> TU MÚSICA")
#   2. Ejecuta: docker compose up -d
#      (Las contraseñas se generan automáticamente en el primer arranque)
#   3. Abre: http://localhost:4567
#
# DESCARGAR ESTE ARCHIVO:
#   mkdir echo && cd echo
#   curl -O https://raw.githubusercontent.com/Alexzafra13/echo/main/docker-compose.yml
#
# =============================================

services:
  echo:
    image: ghcr.io/alexzafra13/echo:latest
    container_name: echo
    ports:
      - "${ECHO_PORT:-4567}:4567"
    volumes:
      - ./data:/app/data

      # ===========================================
      #        >>> TU MÚSICA - EDITA AQUÍ <<<
      # ===========================================
      # Añade las carpetas donde tienes tu música.
      # Formato: /ruta/en/tu/pc:/ruta/en/echo:ro
      # El :ro significa solo lectura (recomendado)
      #
      # EJEMPLOS:
      # - /home/juan/Musica:/music:ro
      # - /mnt/nas/canciones:/nas:ro
      # - /media/disco-usb:/usb:ro
      # - "D:/Mi Musica:/music:ro"  # Windows
      #
      # Por defecto se montan /mnt y /media:
      - /mnt:/mnt:ro
      - /media:/media:ro
      # ===========================================

    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER:-echo}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-echo}
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      DATA_PATH: /app/data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - echo-network
    # Evitar logs infinitos en disco
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  postgres:
    image: postgres:16-alpine
    container_name: echo-postgres
    # Memoria compartida para mejor rendimiento con operaciones complejas
    shm_size: 128mb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-echo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-echo}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-echo}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - echo-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    container_name: echo-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--pass", "${REDIS_PASSWORD}", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - echo-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  echo-network:
    name: echo-network

volumes:
  postgres_data:
  redis_data:
