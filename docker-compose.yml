# =============================================
# Echo Music Server
# =============================================
#
# INSTALACIÓN RÁPIDA:
#
#   1. Configura tus rutas de música abajo (busca ">>> TU MÚSICA")
#   2. Ejecuta: docker compose up -d
#   3. Abre: http://localhost:4567
#
# PARA PLUGINS (opcional):
#   Si quieres instalar plugins desde la UI, ejecuta:
#   DOCKER_GID=$(getent group docker | cut -d: -f3) docker compose up -d
#
# DESCARGAR ESTE ARCHIVO:
#   mkdir echo && cd echo
#   curl -O https://raw.githubusercontent.com/Alexzafra13/echo/main/docker-compose.yml
#
# =============================================

services:
  echo:
    image: ghcr.io/alexzafra13/echo:latest
    container_name: echo
    ports:
      - "${ECHO_PORT:-4567}:4567"
    volumes:
      - ./data:/app/data

      # ===========================================
      #        >>> TU MÚSICA - EDITA AQUÍ <<<
      # ===========================================
      # Añade las carpetas donde tienes tu música.
      # Formato: /ruta/en/tu/pc:/ruta/en/echo:ro
      # El :ro significa solo lectura (recomendado)
      #
      # EJEMPLOS:
      # - /home/juan/Musica:/music:ro
      # - /mnt/nas/canciones:/nas:ro
      # - /media/disco-usb:/usb:ro
      # - "D:/Mi Musica:/music:ro"  # Windows
      #
      # Por defecto se montan /mnt y /media:
      - /mnt:/mnt:ro
      - /media:/media:ro
      # ===========================================

      # Docker socket para gestión de plugins desde la UI
      - /var/run/docker.sock:/var/run/docker.sock
    # Permisos para acceder al socket de Docker
    # Obtén el GID con: getent group docker | cut -d: -f3
    group_add:
      - "${DOCKER_GID:-999}"

    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER:-echo}:${POSTGRES_PASSWORD:-echo_music_server}@postgres:5432/${POSTGRES_DB:-echo}
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-echo_music_server}
      DATA_PATH: /app/data
      # Stems plugin URL (optional - only if stems profile is enabled)
      STEMS_PLUGIN_URL: http://echo-stems:5000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - echo-network
    # Evitar logs infinitos en disco
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  postgres:
    image: postgres:16-alpine
    container_name: echo-postgres
    # Memoria compartida para mejor rendimiento con operaciones complejas
    shm_size: 128mb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-echo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-echo_music_server}
      POSTGRES_DB: ${POSTGRES_DB:-echo}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-echo}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - echo-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    container_name: echo-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-echo_music_server}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--pass", "${REDIS_PASSWORD:-echo_music_server}", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - echo-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # PLUGIN: Separación de Stems (OPCIONAL)
  # ===========================================
  # Activa con: docker compose --profile stems up -d
  # Este plugin permite separar canciones en:
  # vocals, drums, bass, otros
  # Tamaño de imagen: ~1.3GB
  # ===========================================
  echo-stems:
    image: ghcr.io/alexzafra13/echo-stems:latest
    container_name: echo-stems
    profiles:
      - stems
    volumes:
      - stems_data:/app/data
    environment:
      DEMUCS_MODEL: htdemucs
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health')"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 3
    restart: unless-stopped
    networks:
      - echo-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # Recursos recomendados para ML
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G

networks:
  echo-network:
    name: echo-network

volumes:
  postgres_data:
  redis_data:
  stems_data:
